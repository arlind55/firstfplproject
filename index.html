<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FPL Fixture Ticker with Rankings & Sorting</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 2rem;
    background: #f7f7f9;
    color: #222;
  }
  h2, h3 {
    text-align: center;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    margin-bottom: 3rem;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }
  th.sortable:hover {
    cursor: pointer;
    background-color: #f0f0f0;
  }
  .team-name {
    text-align: left;
    padding-left: 10px;
    font-weight: bold;
    background: #fafafa;
  }
  .easy {background: #bbf2b9;}
  .medium {background: #ffe796;}
  .hard {background: #ffbaba;}
  .loading {
    text-align: center; font-style: italic; color: #666; margin: 2rem 0;
  }
  .away-marker {
    font-weight: 800;
    color: #556;
  }
</style>
</head>
<body>

<h2>Premier League Team Rankings & Fixtures</h2>
<div id="loading">Loading data, please wait...</div>

<h3>Team Rankings: Home & Away</h3>
<table id="rankingTable" style="display:none;">
  <thead>
    <tr>
      <th>Team</th>
      <th class="sortable" onclick="sortRankTable('homeRank')">Home Rank ▲▼</th>
      <th class="sortable" onclick="sortRankTable('awayRank')">Away Rank ▲▼</th>
      <th class="sortable" onclick="sortRankTable('overallRank')">Overall Rank ▲▼</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Fixture Ticker (Next Fixtures)</h3>
<label for="gwRange">Show Gameweeks:</label>
<input type="range" id="gwRange" min="3" max="10" value="6" oninput="updateGWLabel(this.value)" />
<span id="gwLabel">1–6</span>

<table id="fixtureTable" style="display:none;">
  <!-- Dynamically filled -->
</table>

<script>
  // CORS proxy is used to allow local testing, you can remove it in production
  const proxy = 'https://api.allorigins.win/raw?url=';

  const apiFixtures = 'https://fantasy.premierleague.com/api/fixtures/';
  const apiBootstrap = 'https://fantasy.premierleague.com/api/bootstrap-static/';
  const apiStandings = 'https://fantasy.premierleague.com/api/leagues-classic/314/standings/';

  let teams = [];
  let fixtures = [];
  let standings = [];
  let gwCount = 6;
  let rankSortOrder = { key: null, asc: true };

  function diffClass(diff) {
    if (diff <= 2) return 'easy';
    if (diff === 3) return 'medium';
    return 'hard';
  }

  async function fetchJSON(url) {
    const res = await fetch(proxy + encodeURIComponent(url));
    if(!res.ok) throw new Error('Network response not ok');
    return await res.json();
  }

  async function fetchData() {
    try {
      const [bootstrap, fixtureData, standingsData] = await Promise.all([
        fetchJSON(apiBootstrap),
        fetchJSON(apiFixtures),
        fetchJSON(apiStandings)
      ]);

      teams = bootstrap.teams;
      fixtures = fixtureData;
      
      // classic league 314 standings, getting top 20 teams with home/away data
      standings = standingsData.standings.results.filter(t => teams.find(team => team.id === t.id)).slice(0,20);

      document.getElementById('loading').style.display = 'none';
      document.getElementById('rankingTable').style.display = 'table';
      document.getElementById('fixtureTable').style.display = 'table';

      renderRankingsTable();
      renderFixturesTable();
    } catch(err) {
      document.getElementById('loading').textContent = 'Failed to load data: ' + err.message;
      console.error(err);
    }
  }

  function getTeamById(id) {
    return teams.find(t => t.id === id);
  }

  // Render the rankings at top table
  function renderRankingsTable() {
    const tbody = document.querySelector('#rankingTable tbody');
    tbody.innerHTML = '';

    let rows = standings.map(r => {
      const team = getTeamById(r.id);
      return {
        name: team ? team.name : 'Unknown',
        homeRank: r.home_rank,
        awayRank: r.away_rank,
        overallRank: r.event_total_rank,
        id: r.id
      };
    });

    // sort if a sort is set
    if(rankSortOrder.key){
      rows.sort((a,b) => rankSortOrder.asc ?
        a[rankSortOrder.key] - b[rankSortOrder.key] :
        b[rankSortOrder.key] - a[rankSortOrder.key]);
    }

    for (const r of rows) {
      tbody.innerHTML += `<tr>
        <td class="team-name">${r.name}</td>
        <td>${r.homeRank}</td>
        <td>${r.awayRank}</td>
        <td>${r.overallRank}</td>
      </tr>`;
    }
  }

  function sortRankTable(key) {
    if(rankSortOrder.key === key){
      rankSortOrder.asc = !rankSortOrder.asc; // toggle asc/desc
    } else {
      rankSortOrder.key = key;
      rankSortOrder.asc = true;
    }
    renderRankingsTable();
  }

  // Group fixtures by teamId for quick lookup
  function groupFixturesByTeam() {
    const byTeam = {};
    teams.forEach(t => { byTeam[t.id] = []; });

    fixtures.forEach(f =>
